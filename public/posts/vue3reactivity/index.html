<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Vue3 æºç ä¸­çš„ Reactivity å­¦ä¹ å’Œæ€è€ƒ - OK Computer</title><meta name="Description" content="WUMANHOçš„åšå®¢"><meta property="og:title" content="Vue3 æºç ä¸­çš„ Reactivity å­¦ä¹ å’Œæ€è€ƒ" />
<meta property="og:description" content="å†™ä¸€ä¸ª Vue3 Reactivity" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/vue3reactivity/" /><meta property="og:image" content="/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-16T22:55:29+08:00" />
<meta property="article:modified_time" content="2022-03-16T22:55:29+08:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="/logo.png"/>

<meta name="twitter:title" content="Vue3 æºç ä¸­çš„ Reactivity å­¦ä¹ å’Œæ€è€ƒ"/>
<meta name="twitter:description" content="å†™ä¸€ä¸ª Vue3 Reactivity"/>
<meta name="application-name" content="å¥½ç”µè„‘">
<meta name="apple-mobile-web-app-title" content="å¥½ç”µè„‘"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="/posts/vue3reactivity/" /><link rel="prev" href="/posts/cfworkers/" /><link rel="next" href="/posts/webhook-auto-deploy/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Vue3 æºç ä¸­çš„ Reactivity å­¦ä¹ å’Œæ€è€ƒ",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "\/posts\/vue3reactivity\/"
        },"genre": "posts","keywords": "Vue3, æºç , å“åº”å¼","wordcount":  3770 ,
        "url": "\/posts\/vue3reactivity\/","datePublished": "2022-03-16T22:55:29+08:00","dateModified": "2022-03-16T22:55:29+08:00","publisher": {
            "@type": "Organization",
            "name": "wumanho"},"author": {
                "@type": "Person",
                "name": "wumanho"
            },"description": ""
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('dark' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'dark' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="OK Computer">OK Computer</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> æ–‡ç«  </a><a class="menu-item" href="/tags/"> æ ‡ç­¾ </a><a class="menu-item" href="/categories/"> åˆ†ç±» </a><a class="menu-item" href="/about/"> å…³äº </a><a class="menu-item" href="/friend/"> å‹æƒ…é“¾æ¥ </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="åˆ‡æ¢ä¸»é¢˜">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="OK Computer">OK Computer</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">æ–‡ç« </a><a class="menu-item" href="/tags/" title="">æ ‡ç­¾</a><a class="menu-item" href="/categories/" title="">åˆ†ç±»</a><a class="menu-item" href="/about/" title="">å…³äº</a><a class="menu-item" href="/friend/" title="">å‹æƒ…é“¾æ¥</a><a href="javascript:void(0);" class="menu-item theme-switch" title="åˆ‡æ¢ä¸»é¢˜">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">ç›®å½•</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Vue3 æºç ä¸­çš„ Reactivity å­¦ä¹ å’Œæ€è€ƒ</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/about/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>wumanho</a></span>&nbsp;<span class="post-category">æ”¶å½•äº <a href="/categories/%E5%89%8D%E7%AB%AF/"><i class="far fa-folder fa-fw"></i>å‰ç«¯</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2022-03-16">2022-03-16</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;çº¦ 3770 å­—&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;é¢„è®¡é˜…è¯» 8 åˆ†é’Ÿ&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>ç›®å½•</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#å‰è¨€">å‰è¨€</a></li>
    <li><a href="#reactive-çš„æœ¬è´¨">Reactive çš„æœ¬è´¨</a></li>
    <li><a href="#ref-å®ç°">ref å®ç°</a></li>
    <li><a href="#æ‰“åŒ…å¹¶æµ‹è¯•-ref">æ‰“åŒ…å¹¶æµ‹è¯• ref</a></li>
    <li><a href="#ä¼˜åŒ–">ä¼˜åŒ–</a></li>
    <li><a href="#æ€»ç»“">æ€»ç»“</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="å‰è¨€">å‰è¨€</h2>
<p>æ­£å¼å¼€å§‹è¯» Vue3 æºç æ˜¯ä» Vue3 è½¬æ­£æˆä¸ºé»˜è®¤ç‰ˆæœ¬å¼€å§‹çš„ï¼Œä»å•å…ƒæµ‹è¯•å…¥æ‰‹ï¼Œå¾—ç›Šäº Evan You è‰¯å¥½çš„ç¼–ç é£æ ¼ï¼Œå‘ç°åˆ¨é™¤äº† TS çš„ç±»å‹å£°æ˜ä¹‹åå…¶å®å¹¶æ²¡æœ‰æƒ³è±¡ä¸­å¤æ‚ã€‚</p>
<p>å†™è¿™ç¯‡åšå®¢ä¸»è¦æ˜¯è®°å½•ä¸€äº›å­¦ä¹ ä¸­çš„æ€è€ƒï¼Œä»¥ç™½è¯æ–‡ä¸ºä¸»ï¼Œä¸€æ–¹é¢æ˜¯æºç è§£è¯»ç›¸å…³çš„åšå®¢å’Œæ–‡ç« æ•™ç¨‹å®åœ¨æ˜¯å¤ªå¤šäº†ï¼Œå¦å¤–è¿˜æœ‰ä¸€ä¸ªæ›´é‡è¦çš„åŸå› å°±æ˜¯ Vue Core Team çš„éœæ˜¥é˜³å¤§ä½¬æœ€è¿‘å‡ºç‰ˆçš„ã€ŠVue.js è®¾è®¡ä¸å®ç°ã€‹å†™å¾—å®åœ¨æ˜¯å¤ªå¥½äº†ï¼Œå¥½åˆ°è®©äººæ”¾å¼ƒäº†æ­£ç»å†™åšå®¢çš„æ¬²æœ›ï¼Œå› ä¸ºåœ¨è¿™æœ¬ä¹¦é¢å‰è¿™äº›åŠªåŠ›éƒ½æ˜¾å¾—éå¸¸å¤šä½™ğŸ˜„ ã€‚</p>
<p>è‡³äºè¯»æºç åˆ°åº•æœ‰æ²¡æœ‰æ„ä¹‰ï¼Œè¿˜æ˜¯åªæ˜¯å•çº¯æ˜¯å†…å·çš„ä¸€ç§è¡¨ç°ã€‚é¦–å…ˆæˆ‘æ˜¯è§‰å¾—æ‹’ç»å†…å·å¹¶ä¸æ˜¯æ‹’ç»è¿›æ­¥ï¼Œåªè¦ä½ è®¤ä¸ºå¯¹è‡ªå·±æœ‰ä»·å€¼çš„äº‹ï¼Œé‚£è¿˜æ˜¯éå¸¸å€¼å¾—å»åšä¸€åšçš„ã€‚</p>
<p>å…¶æ¬¡æ˜¯åªè¦åœ¨è¿™è¡Œå·¥ä½œä¹…äº†ï¼Œå°±ä¸éš¾å‘ç°å®ç°ä¸€ä¸ª<strong>åº“</strong>ï¼ˆä¿—ç§°è½®å­ï¼‰è·Ÿåœ¨å…¬å¸é‡ŒåŸ‹å¤´å†™<strong>ä¸šåŠ¡ä»£ç </strong>æ˜¯ä¸¤ç§å®Œå…¨ä¸ä¸€æ ·çš„æ¦‚å¿µï¼Œå¤§å¤šæ•°äººåœ¨å…¬å¸å†™ä»£ç åŸºæœ¬ä¸Šå°±æ˜¯ç”¨æ¡†æ¶æä¾›çš„ API å®ç°ä¸šåŠ¡åŠŸèƒ½ï¼Œç”±äºä»£ç è·Ÿä¸šåŠ¡å…³è”æ€§å¾ˆå¼ºï¼Œä½ å®Œå…¨å¯ä»¥ä¸€æœ¬é“ï¼Œæƒ³åˆ°ä»€ä¹ˆå†™ä»€ä¹ˆï¼Œåƒå†™è„šæœ¬ä¸€æ ·ä¸€è¡Œä¸€è¡Œå†™ä¸‹å»å°±è¡Œäº†ï¼Œåæ­£å…¶ä»–äº‹æƒ…æœ‰æ¡†æ¶å¸®ä½ å…œåº•ã€‚</p>
<p>ä½†æ¡†æ¶å°±å®Œå…¨ä¸ä¸€æ ·ï¼Œæ¡†æ¶éœ€è¦é€‚åº”æ‰€æœ‰ä¸šåŠ¡åŠŸèƒ½ï¼Œæ‰€ä»¥å®ƒæ˜¯æŠ½è±¡çš„ï¼Œå®ƒéœ€è¦å¼€å‘è€…æœ‰ä¸€å®šç¨‹åº¦çš„æŠ½è±¡èƒ½åŠ›ï¼Œè¿™ç§èƒ½åŠ›æˆ‘ä¸ªäººè®¤ä¸ºé•¿å¹´ç´¯æœˆå†™ä¸šåŠ¡ä»£ç æ˜¯æ— æ³•é”»ç‚¼å‡ºæ¥çš„ï¼Œå‰ç«¯ç¨‹åºå‘˜å¹²ä¸‰å¹´éƒ½æœªå¿…ä¼šå†™ä¸€ä¸ª Classï¼ˆ Java ç¨‹åºå‘˜ä¹Ÿä¸€æ ·ï¼Œåªæ˜¯ Java è¦æ±‚ä½ å¿…é¡»è¦å†™ç±»å‹ï¼Œè¿™ä½¿å¾—ä½ çš„ä»£ç çœ‹èµ·æ¥äººæ¨¡äººæ ·çš„ï¼Œå®é™…ä¸Šç…§æ ·æ˜¯åœ¨å†™è„šæœ¬è€Œå·²ğŸ˜‘ï¼‰ï¼Œæ‰€ä»¥é™¤äº†äº²è‡ªåŠ¨æ‰‹é€ ä¸€äº›è½®å­ä»¥å¤–ï¼Œé˜…è¯»æ¡†æ¶æºç ç»™æ¯ä¸€ä½ç¨‹åºå‘˜å¸¦æ¥çš„æå‡(ä¸»è¦æ˜¯æ€æƒ³ä¸Š)æ˜¯ä¸è¨€è€Œå–»çš„ï¼Œè‡³å°‘å¯ä»¥å¸¦ç»™äººä¸€ç§çœ‹èµ·æ¥æˆ‘ä¹Ÿèƒ½åšçš„è‡ªä¿¡å¿ƒã€‚</p>
<p>è¯æœ‰ç‚¹å¤šäº†ğŸ˜¦</p>
<p>Â </p>
<h2 id="reactive-çš„æœ¬è´¨">Reactive çš„æœ¬è´¨</h2>
<p>è¿™ä¸ªè¯é¢˜ä» Vue2 è®²åˆ° Vue3 ï¼Œéƒ½å¿«è¢«è®²çƒ‚äº†ï¼Œä½†æˆ‘è§‰å¾—é‡ç‚¹ä¸åœ¨äºå¦‚ä½•å®ç°ï¼Œæ›´é‡è¦æ˜¯æ˜¯ç†è§£å®ƒçš„æœ¬è´¨ï¼Œå› ä¸º Vue2 å’Œ Vue3 çš„å“åº”å¼æ ¸å¿ƒæ€æƒ³æ˜¯æ²¡æœ‰å¤ªå¤šå‡ºå…¥çš„ï¼Œä¸åŒçš„åªæ˜¯å®ç°æ–¹å¼ã€‚</p>
<p>ä¸è¿‡æˆ‘è§‰å¾—å¦‚æœéšä¾¿æŠ“ä¸€ä¸ªå‰ç«¯æ¥è®©ä»–å®ç°ä¸€ä¸ªæœ€ç®€å•çš„ Reactivity ï¼Œå…¶å®çœŸä¸ä¸€å®šæ¯ä¸ªäººéƒ½èƒ½åšå‡ºæ¥ï¼Œæ‰€ä»¥æˆ‘è¿˜æ˜¯èŠ±äº†ä¸€äº›æ—¶é—´å»æ€»ç»“ï¼Œä¸å…¶è¯´ Reactivity æ˜¯ä¸€ç§æŠ€æœ¯ï¼Œæ›´è´´åˆ‡çš„è¯´æ³•åº”è¯¥æ˜¯ä¸€ç§æ€æƒ³ã€‚</p>
<p>å®ƒçš„æœ¬è´¨å°±æ˜¯å½“ä¸€ä¸ªè¢«ç”¨æˆ·å…³æ³¨çš„æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè§¦å‘ä¸€ç³»åˆ—ç›¸å¯¹åº”çš„åŠ¨ä½œï¼Œåœ¨ Vue ä¸­è¿™ä¸ªåŠ¨ä½œé€šå¸¸æ˜¯æ›´æ–°é¡µé¢ï¼Œè¿™äº›åŠ¨ä½œåœ¨æºç ä¸­è¢«æè¿°ä¸º <a href="https://github.com/vuejs/core/blob/main/packages/reactivity/src/effect.ts" target="_blank" rel="noopener noreffer">effect</a> ï¼Œå®˜æ–¹å–œæ¬¢ç”¨ä¸­æ–‡<code>å‰¯ä½œç”¨</code>æ¥ç§°å‘¼ï¼Œé‚£ä¹ˆå¦‚æœè¦è‡ªå·±å®ç°çš„è¯ï¼Œ<code>effect</code>åº”è¯¥æ˜¯é•¿è¿™æ ·çš„ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">&#34;en&#34;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&#34;UTF-8&#34;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Title<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;module&#34;</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;./main.js&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;app&#34;</span><span class="p">&gt;</span>Hello!<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="cm">/*=== main.js ===*/</span>

<span class="c1">//æŒ‚è½½åˆ° window ä¸Šæ–¹ä¾¿æ¼”ç¤º
</span><span class="c1"></span><span class="nb">window</span><span class="p">.</span><span class="nx">text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">effect</span> <span class="o">=</span> <span class="nx">effect</span>

<span class="kd">function</span> <span class="nx">effect</span><span class="p">()</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">root</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;app&#39;</span><span class="p">)</span>
    <span class="nx">root</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">text</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/effect.gif"
        data-srcset="https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/effect.gif, https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/effect.gif 1.5x, https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/effect.gif 2x"
        data-sizes="auto"
        alt="https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/effect.gif"
        title="https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/effect.gif" /></p>
<p>è¿™å°±æ˜¯ Reactivity çš„é›å½¢ï¼Œå½“æˆ‘æŠŠ text çš„å€¼æ”¹å˜åï¼Œæ‰‹åŠ¨è§¦å‘äº†ä¸€ä¸‹<code>effect()</code>ï¼Œé¡µé¢ä¸Šçš„å€¼å°±æ›´æ–°äº†ï¼Œä½†æ˜¾ç„¶è¿™è·Ÿé¢„æœŸæœ‰å¾ˆå¤§å‡ºå…¥ï¼Œè¿™å“åº”å¼æ€ä¹ˆè¿˜è¦æ‰‹åŠ¨è§¦å‘ï¼Ÿ</p>
<p>äºæ˜¯ï¼Œä¸€ä¸ªååˆ†å¤©æ‰çš„æƒ³æ³•è¯ç”Ÿäº†ï¼Œå¦‚æœæŠŠæ‰€æœ‰å¼•ç”¨äº†<code>text</code>è¿™ä¸ªå€¼çš„<code>effect</code>çœ‹ä½œä¸º<code>text</code>çš„<strong>ä¾èµ–</strong>æ”¶é›†èµ·æ¥ï¼Œå½“æˆ‘ä»¬æ”¹å˜<code>text</code>çš„å€¼çš„æ—¶å€™ï¼ŒæŠŠè¿™äº›<strong>ä¾èµ–</strong>éƒ½æ‰§è¡Œä¸€éï¼Œé‚£ä¸å°±å®Œç¾è§£å†³äº†è¿™ä¸ªé—®é¢˜äº†å—ã€‚</p>
<p>Â </p>
<h2 id="ref-å®ç°">ref å®ç°</h2>
<p>Vue3 æºç ä¸­ï¼Œ<a href="https://github.com/vuejs/core/blob/main/packages/reactivity/src/ref.ts" target="_blank" rel="noopener noreffer">ref.ts</a> çš„æ ¸å¿ƒé€»è¾‘é™¤å»æ³¨é‡Šåªæœ‰ä¸åˆ° 300 è¡Œä»£ç ï¼Œä¸çœ‹å…·ä½“å®ç°ï¼ˆå¦‚ track çš„è¿‡ç¨‹ç­‰ï¼‰çš„è¯ï¼Œéå¸¸å®¹æ˜“ç†è§£å®ƒåœ¨è¯•å›¾åšäº›ä»€ä¹ˆã€‚</p>
<p>å…ˆçœ‹ä¸€ä¸‹å®ƒçš„ä¸¤ä¸ªå…³é”®çš„å•æµ‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="cm">/** å®˜æ–¹ä»“åº“ï¼š packages/reactivity/__tests__/ref.spec.ts **/</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;reactivity/ref&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">//ç»™ ref ä¼ ä¸€ä¸ªå€¼ï¼Œå¯ä»¥é€šè¿‡ .value è·å–åˆ°
</span><span class="c1"></span>  <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should hold a value&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">value</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">value</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
  <span class="p">})</span>
    <span class="c1">//è€Œä¸”è¿™ä¸ªå€¼ä¼šæ˜¯å“åº”å¼çš„
</span><span class="c1"></span>  <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should be reactive&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="kd">let</span> <span class="nx">dummy</span>
    <span class="kd">let</span> <span class="nx">calls</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nx">effect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">calls</span><span class="o">++</span>
      <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">value</span>
    <span class="p">})</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">calls</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">dummy</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">calls</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">dummy</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1">// å¦‚æœæ˜¯å€¼æ²¡æœ‰æ”¹å˜ï¼Œé‚£ä¹ˆå°± calls å°±ä¸å˜
</span><span class="c1"></span>    <span class="nx">a</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">calls</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
  <span class="p">})</span>
<span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div><p>äº†è§£äº†å¤§æ¦‚çš„ç”¨æ³•ä¹‹åå°±å¯ä»¥å¼€å§‹åŠ¨æ‰‹å®ç°äº†ï¼Œå…ˆè¯•è¯•æ”»å…‹ç¬¬ä¸€ä¸ªæµ‹è¯•å§ã€‚</p>
<p>ä¼ ç»™ ref çš„å‚æ•° 1 æ˜¯ä¸€ä¸ªåŸºæœ¬çš„æ•°å­—ç±»å‹ï¼Œæ•°å­—ç±»å‹æ˜¯ä¸å¯èƒ½æœ‰ .value å±æ€§çš„ï¼Œæ‰€ä»¥ ref å†…éƒ¨è‚¯å®šæ˜¯è¿”å›äº†ä¸€ä¸ªå¯¹è±¡ğŸ¤”ï¼Œæˆ‘ä»¬å°±ç§°ä»–ä¸º<code>RefImpl</code>å§ï¼ˆå¥½å§è¿™ä¸ªåå­—æ˜¯ç›´æ¥ä»æºç é‡ŒæŠ„çš„ï¼Œä½ å¯ä»¥ç›´æ¥åœ¨æºç é‡Œæœç´¢åˆ°ï¼‰</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="cm">/** ref.ts **/</span>
<span class="kr">class</span> <span class="nx">RefImpl</span> <span class="p">{</span>
    <span class="kr">private</span> <span class="nx">_value</span>: <span class="kt">any</span>
    
    <span class="kr">constructor</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_value</span> <span class="o">=</span> <span class="nx">value</span>
    <span class="p">}</span>
    <span class="kr">get</span> <span class="nx">value() {</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_value</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ç„¶åæ˜¯ ref æ–¹æ³•ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="cm">/** ref.ts **/</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">ref</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">RefImpl</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>è‡³æ­¤ï¼Œç¬¬ä¸€ä¸ªå•æµ‹åº”è¯¥æ˜¯å¯ä»¥é€šè¿‡çš„ï¼Œref æ–¹æ³•å°† value å‚æ•°ä¼ é€’ç»™<code>RefImpl</code>çš„æ„é€ å‡½æ•°ï¼Œæä¾›ä¸€ä¸ª<code>get</code>æ–¹æ³•ï¼Œå°†è¿™ä¸ª<code>RefImpl</code>è¿”å›å‡ºå»å°±å³å¯ã€‚</p>
<p>ä¸éš¾å‘ç°ï¼Œä¹‹æ‰€ä»¥è¦å°è£…ä¸€ä¸ª<code>RefImpl</code>ç±»ï¼Œæ˜¯ä¸ºäº†å¯ä»¥å®ç°ä¸€äº›æ‹¦æˆªçš„åŠ¨ä½œï¼Œå½“ç”¨æˆ·ä½¿ç”¨ .value è·å–å€¼çš„æ—¶å€™ï¼Œå¯ä»¥åˆ©ç”¨ç±»çš„<code>get</code>æ–¹æ³•æ‹¦æˆªè¿™ä¸ªåŠ¨ä½œï¼Œæ¥è¾¾åˆ°<strong>æ”¶é›†ä¾èµ–</strong>çš„ç›®çš„ï¼Œè€Œå½“ç”¨æˆ·åˆ©ç”¨<code>set</code>æ–¹æ³•æ¥è¯•å›¾æ”¹å˜è¿™ä¸ªå€¼çš„æ—¶å€™ï¼Œä¾¿å¯ä»¥<strong>è§¦å‘ä¾èµ–</strong>ï¼Œå°†æ”¶é›†åˆ°çš„ä¾èµ–æ‰§è¡Œï¼Œæ¥è¾¾åˆ°å“åº”å¼çš„ç›®çš„ã€‚</p>
<p>æ‰€ä»¥æ¥ä¸‹æ¥å°±å¯ä»¥å¼€å§‹åŠ¨æ‰‹æ”»å…‹ç¬¬äºŒä¸ªæµ‹è¯•äº†ï¼Œè¯•è¯•å°†æ•°æ®å˜æˆå“åº”å¼çš„å§ã€‚</p>
<p>åœ¨ Vue3 çš„ Reactive ä¸­ï¼Œ<code>effect</code>èµ·åˆ°ä¸€ä¸ªéå¸¸å…³é”®çš„ä½œç”¨ï¼Œå¯ä»¥è¯´æ˜¯ Reactive çš„æ ¸å¿ƒï¼ŒVue3 æä¾›<code>reactive</code>å’Œ<code>ref</code>è¿™ä¸¤ä¸ªå“åº”å¼çš„ APIï¼Œæ— è®ºç”¨æˆ·ä½¿ç”¨å“ªä¸ªï¼Œæœ€ç»ˆ<strong>æ”¶é›†ä¾èµ–</strong>éƒ½æ˜¯é€šè¿‡<code>effect</code>æ¥å®Œæˆçš„ï¼Œ<code>reactive</code>å’Œ<code>ref</code>ä¸»è¦æ˜¯åšä¸€äº›æ‹¦æˆªçš„åŠ¨ä½œï¼Œä¸º<code>effect</code>æä¾›å…¥å£ã€‚</p>
<p><code>effect()</code> æ¥æ”¶ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œå¹¶å°è£…åˆ° <code>ReactiveEffect</code> ç±»ä¸­ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="cm">/** effect.ts **/</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">effect</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//å°†ä¾èµ–å°è£…åˆ° reactiveeffect ç±»çš„runæ–¹æ³•ä¸­
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">_effect</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ReactiveEffect</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span>
    <span class="c1">//é©¬ä¸Šæ‰§è¡Œä¸€ä¸‹
</span><span class="c1"></span>    <span class="nx">_effect</span><span class="p">.</span><span class="nx">run</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="cm">/** effect.ts **/</span>

<span class="c1">//å…¨å±€å®¹å™¨ï¼Œç”¨äºä¿å­˜å½“å‰çš„ ReactiveEffect å®ä¾‹
</span><span class="c1"></span><span class="kd">let</span> <span class="nx">activeEffect</span>: <span class="kt">any</span>

<span class="kr">class</span> <span class="nx">ReactiveEffect</span> <span class="p">{</span>
     <span class="kr">private</span> <span class="kr">readonly</span> <span class="nx">_fn</span>: <span class="kt">any</span>

    <span class="kr">constructor</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_fn</span> <span class="o">=</span> <span class="nx">fn</span>
    <span class="p">}</span>
    <span class="c1">//å°è£…çš„ run æ–¹æ³•ï¼Œæ‰§è¡Œ effect ä¼ å…¥çš„å›è°ƒå‡½æ•°
</span><span class="c1"></span>    <span class="nx">run() {</span>
        <span class="nx">activeEffect</span> <span class="o">=</span> <span class="k">this</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_fn</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>å°† fn å°è£…åˆ° <code>ReactiveEffect</code> ä¹‹åï¼Œä¼šç«‹å³è°ƒç”¨ä¸€æ¬¡ run æ–¹æ³•ï¼Œè¿™æ˜¯ä¸ºäº†è§¦å‘ä¸€ä¸‹ä¾èµ–æ”¶é›†ã€‚</p>
<p>ã€Œæ‰§è¡Œä¸€ä¸‹æ˜¯ä¸ºäº†è§¦å‘ä¸€ä¸‹ä¾èµ–æ”¶é›†ã€è¿™å¥è¯å¯èƒ½ä¼šè®©äººæœ‰ç‚¹æ‘¸ä¸ç€å¤´è„‘ï¼Œå…¶å®å¯ä»¥ç”¨å•æµ‹çš„ç”¨ä¾‹ä½œä¸ºä¾‹å­è¯´æ˜ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should be reactive&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">//å£°æ˜äº†ä¸€ä¸ªå“åº”å¼çš„å€¼
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="kd">let</span> <span class="nx">dummy</span>
    <span class="nx">effect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// effect æ¯æ¬¡æ‰§è¡Œçš„æ—¶å€™ï¼Œè®© dymmy = a.value  
</span><span class="c1"></span>      <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">value</span>
    <span class="p">})</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">dummy</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥çœ‹åˆ°ï¼Œä¼ ç»™ effect çš„å›è°ƒå‡½æ•°ä¸­ï¼Œå¼•ç”¨äº†å“åº”å¼æ•°æ®<code>a </code>ï¼Œå½“è¿™ä¸ªå›è°ƒè¢«æ‰§è¡Œï¼Œa.value ä¼šè¢«è§¦å‘ï¼Œè¿™æ—¶å€™å¿…ç„¶ä¼šè¿›å…¥åˆ°ä¹‹å‰åœ¨ <code>RefImpl</code> äº‹å…ˆå®šä¹‰å¥½çš„ get æ‹¦æˆªå™¨ä¸­ï¼Œæ‰€ä»¥è¿™å°±æ˜¯æ”¶é›†ä¾èµ–çš„å¥½æ—¶æœºã€‚</p>
<p>æ‰€ä»¥ï¼Œç°åœ¨æ¥å®ç°ä¸€ä¸‹ï¼Œåœ¨å“åº”å¼å¯¹è±¡çš„ get è¢«è°ƒç”¨æ—¶ï¼Œæ‰§è¡Œ<code>track</code>å‡½æ•°æ¥è¿›è¡Œä¾èµ–æ”¶é›†ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="hl"><span class="lnt"> 6
</span></span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="hl"><span class="lnt"> 9
</span></span><span class="lnt">10
</span><span class="lnt">11
</span><span class="hl"><span class="lnt">12
</span></span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="cm">/** ref.ts **/</span>
<span class="kr">import</span> <span class="p">{</span><span class="nx">track</span><span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;./effect&#34;</span><span class="p">;</span>

<span class="kr">class</span> <span class="nx">RefImpl</span> <span class="p">{</span>
    <span class="kr">private</span> <span class="nx">_value</span>: <span class="kt">any</span>
<span class="hl">    <span class="kr">public</span> <span class="nx">deps</span>
</span>    <span class="kr">constructor</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_value</span> <span class="o">=</span> <span class="nx">value</span>
<span class="hl">        <span class="k">this</span><span class="p">.</span><span class="nx">deps</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Set</span><span class="p">()</span>
</span>    <span class="p">}</span>
    <span class="kr">get</span> <span class="nx">value() {</span>
<span class="hl">        <span class="nx">track</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">deps</span><span class="p">)</span>
</span>        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_value</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>åœ¨æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–ä¸€ä¸ªç”¨äºä¿å­˜ä¾èµ–çš„é›†åˆ<code>deps </code>ï¼Œä¹‹æ‰€ä»¥æ˜¯ Set ä¸»è¦æ˜¯ä¸ºäº†é¿å…é‡å¤æ”¶é›†ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="cm">/** effect.ts **/</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">track</span><span class="p">(</span><span class="nx">dep</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//ä¸å†é‡å¤æ”¶é›†
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">dep</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">activeEffect</span><span class="p">))</span> <span class="k">return</span>
    <span class="nx">dep</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">activeEffect</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ä¸º <code>track</code>ä¼ å…¥å“åº”å¼å¯¹è±¡çš„ <code>dep</code> é›†åˆï¼Œ<code>track</code>å‡½æ•°å°†å½“å‰å…¨å±€ä¿å­˜çš„ <code>activeEffect</code> å¯¹è±¡å­˜åˆ°<code>dep</code>é›†åˆä¸­ã€‚</p>
<p>å®é™…ä¸Šåˆ°è¿™ä¸€æ­¥ï¼Œä¾èµ–æ”¶é›†å°±å·²ç»å®Œæˆäº†ã€‚æ‰€ä»¥æ¥ä¸‹æ¥ï¼Œåªè¦<strong>å½“å“åº”å¼å¯¹è±¡çš„å€¼è¢«æ”¹å˜çš„æ—¶å€™ï¼Œè§¦å‘æ”¶é›†åˆ°çš„æ‰€æœ‰ä¾èµ–</strong>ï¼Œå°±è¿™ä¸ªç®€å•çš„å“åº”å¼æµç¨‹å°±å®Œæˆäº†ã€‚</p>
<p>æ‰€ä»¥ï¼Œåœ¨å“åº”å¼å¯¹è±¡çš„ set æ–¹æ³•ä¸­æ‹¦æˆªè¯·æ±‚ï¼Œåœ¨ä¿®æ”¹å€¼åï¼Œè°ƒç”¨ <code>trigger</code> æ–¹æ³•ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="hl"><span class="lnt"> 2
</span></span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="hl"><span class="lnt">11
</span></span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="hl"><span class="lnt">16
</span></span><span class="hl"><span class="lnt">17
</span></span><span class="hl"><span class="lnt">18
</span></span><span class="hl"><span class="lnt">19
</span></span><span class="hl"><span class="lnt">20
</span></span><span class="hl"><span class="lnt">21
</span></span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="cm">/** ref.ts **/</span>
<span class="hl"><span class="kr">import</span> <span class="p">{</span><span class="nx">track</span><span class="p">,</span><span class="nx">trigger</span><span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;./effect&#34;</span><span class="p">;</span>
</span>
<span class="kr">class</span> <span class="nx">RefImpl</span> <span class="p">{</span>
    <span class="kr">private</span> <span class="nx">_value</span>: <span class="kt">any</span>
    <span class="kr">public</span> <span class="nx">deps</span>
    <span class="kr">constructor</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_value</span> <span class="o">=</span> <span class="nx">value</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">deps</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Set</span><span class="p">()</span>
    <span class="p">}</span>
<span class="hl">    <span class="c1">//æ”¶é›†ä¾èµ–
</span></span><span class="c1"></span>    <span class="kr">get</span> <span class="nx">value() {</span>
        <span class="nx">track</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">deps</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_value</span>
    <span class="p">}</span>
<span class="hl">    
</span><span class="hl">    <span class="c1">//è§¦å‘ä¾èµ–
</span></span><span class="hl"><span class="c1"></span>    <span class="kr">set</span> <span class="nx">value</span><span class="p">(</span><span class="nx">newVal</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hl">       <span class="k">this</span><span class="p">.</span><span class="nx">_value</span> <span class="o">=</span> <span class="nx">newVal</span>
</span><span class="hl">       <span class="nx">trigger</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">deps</span><span class="p">)</span>
</span><span class="hl">    <span class="p">}</span>
</span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="cm">/** effect.ts **/</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">trigger</span><span class="p">(</span><span class="nx">dep</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">effect</span> <span class="k">of</span> <span class="nx">dep</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">effect</span><span class="p">.</span><span class="nx">run</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>åœ¨ set æ‹¦æˆªå™¨ä¸­ï¼Œé¦–å…ˆéœ€è¦å°†å“åº”å¼å¯¹è±¡çš„ value èµ‹å€¼ä¸ºæ–°çš„å€¼ï¼Œç„¶åè°ƒç”¨<code>trigger</code>æ–¹æ³•ï¼Œå°†æ”¶é›†åˆ°çš„<code>deps</code>å…¨éƒ¨ä¼ è¿›å»ï¼Œè€Œ <code>trigger</code> åªéœ€è¦å°†è¿™äº› effect å…¨éƒ¨æ‰§è¡Œä¸€éå°±å¯ä»¥äº†ã€‚</p>
<p>ä¸å¦¨åœ¨æœ¬åœ°è·‘ä¸€ä¸‹å•æµ‹è¯•è¯•çœ‹ï¼š</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/test.gif"
        data-srcset="https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/test.gif, https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/test.gif 1.5x, https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/test.gif 2x"
        data-sizes="auto"
        alt="https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/test.gif"
        title="https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/test.gif" /></p>
<p>æ²¡æœ‰é—®é¢˜ã€‚</p>
<p>Â </p>
<h2 id="æ‰“åŒ…å¹¶æµ‹è¯•-ref">æ‰“åŒ…å¹¶æµ‹è¯• ref</h2>
<p>æœ¬æ¬¡æµ‹è¯•çš„ç›®æ ‡ï¼Œæ˜¯çœ‹çœ‹å¯¹å“åº”å¼æ•°æ®çš„æ›´æ”¹èƒ½ä¸èƒ½å¦‚æœŸåæ˜ åˆ°é¡µé¢ä¸Šã€‚</p>
<p>é¦–å…ˆéœ€è¦å°†å®ç°çš„åº“æ‰“åŒ…ï¼Œå¯¹äºåº“ä»£ç çš„æ‰“åŒ…ï¼Œåƒ Vue3 ä¸€æ ·ä½¿ç”¨ <code>rollup</code>å°±å¯ä»¥äº†ã€‚</p>
<p>å…ˆå°†æœ¬æ¬¡éœ€è¦ç”¨åˆ°çš„ <code>ref</code> å’Œ <code>effect</code> ç»Ÿä¸€å¯¼å‡ºï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="cm">/** src/reactivity/index.ts **/</span>
<span class="kr">export</span> <span class="p">{</span><span class="nx">effect</span><span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;./effect&#34;</span>
<span class="kr">export</span> <span class="p">{</span><span class="nx">ref</span><span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;./ref&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>ç„¶ååœ¨ <code>rollup</code> çš„å…¥å£æ–‡ä»¶é‡Œé¢å¯¼å‡ºï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="cm">/** src/index.ts **/</span>
<span class="kr">export</span> <span class="o">*</span> <span class="kr">from</span> <span class="s2">&#34;./reactivity/index&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>å®‰è£…ä¾èµ–ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">yarn add rollup --dev
</code></pre></td></tr></table>
</div>
</div><p>ç”±äºç”¨åˆ°äº† typescriptï¼Œè¿˜éœ€è¦å®‰è£…ä¸€ä¸‹ <code>rollup</code> æä¾›çš„ ts æ’ä»¶ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">yarn add @rollup/plugin-typescript --dev
yarn add tslib --dev
</code></pre></td></tr></table>
</div>
</div><p>æ·»åŠ <code>rollup.config.js</code>é…ç½®æ–‡ä»¶ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kr">import</span> <span class="nx">typescript</span> <span class="nx">from</span> <span class="s2">&#34;@rollup/plugin-typescript&#34;</span>

<span class="kr">export</span> <span class="k">default</span> <span class="p">{</span>
    <span class="nx">input</span><span class="o">:</span> <span class="s2">&#34;./src/index.ts&#34;</span><span class="p">,</span> <span class="c1">//å…¥å£
</span><span class="c1"></span>    <span class="nx">output</span><span class="o">:</span> <span class="p">[{</span> <span class="c1">//å‡ºå£
</span><span class="c1"></span>        <span class="nx">format</span><span class="o">:</span> <span class="s2">&#34;es&#34;</span><span class="p">,</span>
        <span class="nx">file</span><span class="o">:</span> <span class="s2">&#34;lib/esm.js&#34;</span>
    <span class="p">}],</span>
    <span class="nx">plugins</span><span class="o">:</span> <span class="p">[</span><span class="nx">typescript</span><span class="p">()]</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>æ‰“åŒ…ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">yarn build
</code></pre></td></tr></table>
</div>
</div><p>æœ€åï¼Œè¿˜åŸä¸€å¼€å§‹çš„é‚£ä¸ªç”¨ä¾‹ï¼Œä¸è¿‡æ³¨æ„çœ‹ï¼Œè¿™ä¸ªæ—¶å€™<code>id=&quot;app&quot;</code>çš„ div å†…å®¹æ˜¯ç©ºçš„ ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">&#34;en&#34;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&#34;UTF-8&#34;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Demo<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;module&#34;</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;./main.js&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;app&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>åœ¨è¿™é‡Œï¼Œåˆ©ç”¨ ref å»åˆå§‹åŒ–å…ƒç´ çš„å†…å®¹ä¸ºâ€Hello Ref !â€œ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="cm">/** main.js **/</span>
<span class="kr">import</span> <span class="o">*</span> <span class="nx">as</span> <span class="nx">Ref</span> <span class="nx">from</span> <span class="s2">&#34;../../lib/esm.js&#34;</span>
<span class="kr">import</span> <span class="o">*</span> <span class="nx">as</span> <span class="nx">Effect</span> <span class="nx">from</span> <span class="s2">&#34;../../lib/esm.js&#34;</span>

<span class="kr">const</span> <span class="p">{</span><span class="nx">ref</span><span class="p">}</span> <span class="o">=</span> <span class="nx">Ref</span>
<span class="kr">const</span> <span class="p">{</span><span class="nx">effect</span><span class="p">}</span> <span class="o">=</span> <span class="nx">Effect</span>

<span class="kr">const</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="s2">&#34;Hello Ref !&#34;</span><span class="p">)</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span>

<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">root</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;app&#39;</span><span class="p">)</span>
    <span class="nx">root</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">value</span>
<span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div><p>æ ¹æ® effect çš„ç‰¹æ€§ï¼Œéœ€è¦é©¬ä¸Šæ‰§è¡Œä¸€æ¬¡å›è°ƒå‡½æ•°ï¼Œè¿›è¡Œä¾èµ–æ”¶é›†ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™é¡µé¢ä¸Šåº”è¯¥æ˜¾ç¤º<code>&quot;Hello Ref !&quot;</code>ï¼Œæ¥çœ‹çœ‹æ•ˆæœï¼š</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/final.gif"
        data-srcset="https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/final.gif, https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/final.gif 1.5x, https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/final.gif 2x"
        data-sizes="auto"
        alt="https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/final.gif"
        title="https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/final.gif" /></p>
<p>æ•ˆæœè·Ÿé¢„æœŸçš„ä¸€è‡´ã€‚æ‰€ä»¥ï¼Œå¤§åŠŸå‘Šæˆï¼ğŸ‰</p>
<p>Â </p>
<h2 id="ä¼˜åŒ–">ä¼˜åŒ–</h2>
<p>è®°ä¸è®°å¾—åœ¨å•æµ‹ä¸­è¿˜æœ‰ä¸€ä¸ªå°åŠŸèƒ½ï¼Œå°±æ˜¯ ref çš„å€¼è¢«æ”¹å˜æ—¶ï¼Œå¦‚æœæ–°çš„å€¼è·ŸåŸæœ‰çš„å€¼ä¸€æ ·ï¼Œé‚£ä¹ˆæ˜¯ä¸ä¼šè§¦å‘<code>trigger</code>çš„ï¼Œä¼˜åŒ–äº†ä¸€äº›æ€§èƒ½ï¼Œæ‰€ä»¥åœ¨æœ€åï¼Œæ¥æŠŠè¿™ä¸ªåŠŸèƒ½ç‚¹ä¹Ÿå®ç°ä¸€ä¸‹å§ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="hl"><span class="lnt">14
</span></span><span class="hl"><span class="lnt">15
</span></span><span class="hl"><span class="lnt">16
</span></span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript">  <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should be reactive&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="kd">let</span> <span class="nx">dummy</span>
    <span class="kd">let</span> <span class="nx">calls</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nx">effect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">calls</span><span class="o">++</span>
      <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">value</span>
    <span class="p">})</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">calls</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">dummy</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">calls</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">dummy</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="hl">    <span class="c1">// å¦‚æœæ˜¯å€¼æ²¡æœ‰æ”¹å˜ï¼Œé‚£ä¹ˆå°± calls å°±ä¸å˜
</span></span><span class="hl"><span class="c1"></span>    <span class="nx">a</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="mi">2</span>
</span><span class="hl">    <span class="nx">expect</span><span class="p">(</span><span class="nx">calls</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span>  <span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div><p>æ€è·¯å¾ˆç®€å•ï¼Œæ¯æ¬¡è®¾ç½®æ–°çš„å€¼çš„æ—¶å€™ï¼Œå¯¹æ¯”ä¸€ä¸‹æ–°æ—§çš„å€¼æ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æœä¸ç›¸ç­‰å°±æ‰§è¡Œ<code>trigger</code>ï¼Œç›¸ç­‰çš„è¯å°±è¿”å›</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="hl"><span class="lnt"> 4
</span></span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="hl"><span class="lnt"> 8
</span></span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="hl"><span class="lnt">22
</span></span><span class="hl"><span class="lnt">23
</span></span><span class="lnt">24
</span><span class="lnt">25
</span><span class="hl"><span class="lnt">26
</span></span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="hl"><span class="lnt">30
</span></span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="cm">/** ref.ts **/</span>
<span class="kr">class</span> <span class="nx">RefImpl</span> <span class="p">{</span>
    <span class="kr">private</span> <span class="nx">_value</span>: <span class="kt">any</span>
<span class="hl">    <span class="kr">private</span> <span class="nx">_rawValue</span>: <span class="kt">any</span>
</span>    <span class="kr">public</span> <span class="nx">deps</span>

    <span class="kr">constructor</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
<span class="hl">        <span class="k">this</span><span class="p">.</span><span class="nx">_rawValue</span> <span class="o">=</span> <span class="nx">value</span>
</span>        <span class="k">this</span><span class="p">.</span><span class="nx">_value</span> <span class="o">=</span> <span class="nx">value</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">deps</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Set</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="c1">//æ”¶é›†ä¾èµ–
</span><span class="c1"></span>    <span class="kr">get</span> <span class="nx">value() {</span>
        <span class="nx">track</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">deps</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_value</span>
    <span class="p">}</span>

    <span class="c1">//è§¦å‘ä¾èµ–
</span><span class="c1"></span>    <span class="kr">set</span> <span class="nx">value</span><span class="p">(</span><span class="nx">newVal</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//å¦‚æœæ•°æ®æ²¡æœ‰å˜æ›´ï¼Œä¸è§¦å‘ä¾èµ–
</span><span class="hl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nx">hasChanged</span><span class="p">(</span><span class="nx">newVal</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_rawValue</span><span class="p">))</span> <span class="p">{</span>
</span><span class="hl">            <span class="k">this</span><span class="p">.</span><span class="nx">_rawValue</span> <span class="o">=</span> <span class="nx">newVal</span>
</span>            <span class="k">this</span><span class="p">.</span><span class="nx">_value</span> <span class="o">=</span> <span class="nx">newVal</span>
            <span class="nx">trigger</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">deps</span><span class="p">)</span>
<span class="hl">        <span class="p">}</span>
</span>    <span class="p">}</span>
<span class="p">}</span>

<span class="hl"><span class="kr">const</span> <span class="nx">hasChanged</span> <span class="o">=</span> <span class="p">(</span><span class="nx">newVal</span><span class="p">,</span> <span class="nx">oldVal</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="o">!</span><span class="nb">Object</span><span class="p">.</span><span class="k">is</span><span class="p">(</span><span class="nx">newVal</span><span class="p">,</span> <span class="nx">oldVal</span><span class="p">)</span>
</span></code></pre></td></tr></table>
</div>
</div><p>å†æ¥æ‰§è¡Œä¸€ä¸‹å•æµ‹çœ‹çœ‹æ˜¯å¦å¯ä»¥é€šè¿‡ï¼š</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/finaltest.gif"
        data-srcset="https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/finaltest.gif, https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/finaltest.gif 1.5x, https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/finaltest.gif 2x"
        data-sizes="auto"
        alt="https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/finaltest.gif"
        title="https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/finaltest.gif" /></p>
<p>é¡ºåˆ©é€šè¿‡ã€‚</p>
<p>Â </p>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>è¿™æ¬¡å®ç°çš„<code>ref </code>åªæ˜¯ Reactivity ä¸­çš„å…¶ä¸­ä¸€ä¸ªå°éƒ¨åˆ†ï¼Œ<code>ref</code>åªèƒ½å¯¹å€¼æ•°æ®è¿›è¡Œæ‹¦æˆªï¼Œå¦‚æœéœ€è¦å¯¹ä¸€ä¸ªå¯¹è±¡è¿›è¡Œæ‹¦æˆªï¼Œå°±è¦å®ç°<code>reactive</code>æ–¹æ³•ï¼Œä½†æ ¸å¿ƒæ€è·¯æ²¡æœ‰å¤ªå¤§çš„åŒºåˆ«ï¼Œç»å¸¸å¬è¯´çš„ Vue3 ä½¿ç”¨äº† ES6 çš„<code>Proxy</code>å®ç°äº†å“åº”å¼å°±æ˜¯ä»è¿™é‡Œæ¥çš„ï¼Œä¸è¿‡ç¢äºç¯‡å¹…ï¼Œ<code>reactive</code>å¯èƒ½ä¼šåœ¨ä¸‹ä¸€ç¯‡åšå®¢ä¸­å†å°è¯•å®ç°ï¼Œæ•¬è¯·æœŸå¾…ã€‚</p>
<p><a href="https://github.com/wumanho/vue-ref-for-blog" target="_blank" rel="noopener noreffer">æŸ¥çœ‹æœ¬æ¬¡æ¼”ç¤ºçš„ä»£ç ä»“åº“</a></p>
<p>Â </p>
<p>ï¼ˆå®Œï¼‰</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>æ›´æ–°äº 2022-03-16</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/vue3/">Vue3</a>,&nbsp;<a href="/tags/%E6%BA%90%E7%A0%81/">æºç </a>,&nbsp;<a href="/tags/%E5%93%8D%E5%BA%94%E5%BC%8F/">å“åº”å¼</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">è¿”å›</a></span>&nbsp;|&nbsp;<span><a href="/">ä¸»é¡µ</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/cfworkers/" class="prev" rel="prev" title="ã€Cloudflare Workersã€‘æ— æœåŠ¡å™¨åº”ç”¨åˆä½“éªŒ"><i class="fas fa-angle-left fa-fw"></i>ã€Cloudflare Workersã€‘æ— æœåŠ¡å™¨åº”ç”¨åˆä½“éªŒ</a>
            <a href="/posts/webhook-auto-deploy/" class="next" rel="next" title="åˆ©ç”¨ Github Webhooks å®ç°åšå®¢è‡ªåŠ¨éƒ¨ç½²">åˆ©ç”¨ Github Webhooks å®ç°åšå®¢è‡ªåŠ¨éƒ¨ç½²<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">ç”± <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.92.2">Hugo</a> å¼ºåŠ›é©±åŠ¨ | ä¸»é¢˜ - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2019 - 2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/about/" target="_blank">wumanho</a></span><span class="icp-splitter">&nbsp;|&nbsp;</span><br class="icp-br"/>
                    <span class="icp">ç²¤ICPå¤‡20015586å·</span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="å›åˆ°é¡¶éƒ¨">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="æŸ¥çœ‹è¯„è®º">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"å¤åˆ¶åˆ°å‰ªè´´æ¿","maxShownLines":90},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
