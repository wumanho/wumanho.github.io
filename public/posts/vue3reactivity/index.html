<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Vue3 源码中的 Reactivity 学习和思考 - OK Computer</title><meta name="Description" content="WUMANHO的博客"><meta property="og:title" content="Vue3 源码中的 Reactivity 学习和思考" />
<meta property="og:description" content="写一个 Vue3 Reactivity" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/vue3reactivity/" /><meta property="og:image" content="/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-16T22:55:29+08:00" />
<meta property="article:modified_time" content="2022-03-16T22:55:29+08:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="/logo.png"/>

<meta name="twitter:title" content="Vue3 源码中的 Reactivity 学习和思考"/>
<meta name="twitter:description" content="写一个 Vue3 Reactivity"/>
<meta name="application-name" content="好电脑">
<meta name="apple-mobile-web-app-title" content="好电脑"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="/posts/vue3reactivity/" /><link rel="prev" href="/posts/cfworkers/" /><link rel="next" href="/posts/webhook-auto-deploy/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Vue3 源码中的 Reactivity 学习和思考",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "\/posts\/vue3reactivity\/"
        },"genre": "posts","keywords": "Vue3, 源码, 响应式","wordcount":  3770 ,
        "url": "\/posts\/vue3reactivity\/","datePublished": "2022-03-16T22:55:29+08:00","dateModified": "2022-03-16T22:55:29+08:00","publisher": {
            "@type": "Organization",
            "name": "wumanho"},"author": {
                "@type": "Person",
                "name": "wumanho"
            },"description": ""
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('dark' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'dark' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="OK Computer">OK Computer</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/about/"> 关于 </a><a class="menu-item" href="/friend/"> 友情链接 </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="OK Computer">OK Computer</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/about/" title="">关于</a><a class="menu-item" href="/friend/" title="">友情链接</a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Vue3 源码中的 Reactivity 学习和思考</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/about/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>wumanho</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/%E5%89%8D%E7%AB%AF/"><i class="far fa-folder fa-fw"></i>前端</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2022-03-16">2022-03-16</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 3770 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 8 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#前言">前言</a></li>
    <li><a href="#reactive-的本质">Reactive 的本质</a></li>
    <li><a href="#ref-实现">ref 实现</a></li>
    <li><a href="#打包并测试-ref">打包并测试 ref</a></li>
    <li><a href="#优化">优化</a></li>
    <li><a href="#总结">总结</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="前言">前言</h2>
<p>正式开始读 Vue3 源码是从 Vue3 转正成为默认版本开始的，从单元测试入手，得益于 Evan You 良好的编码风格，发现刨除了 TS 的类型声明之后其实并没有想象中复杂。</p>
<p>写这篇博客主要是记录一些学习中的思考，以白话文为主，一方面是源码解读相关的博客和文章教程实在是太多了，另外还有一个更重要的原因就是 Vue Core Team 的霍春阳大佬最近出版的《Vue.js 设计与实现》写得实在是太好了，好到让人放弃了正经写博客的欲望，因为在这本书面前这些努力都显得非常多余😄 。</p>
<p>至于读源码到底有没有意义，还是只是单纯是内卷的一种表现。首先我是觉得拒绝内卷并不是拒绝进步，只要你认为对自己有价值的事，那还是非常值得去做一做的。</p>
<p>其次是只要在这行工作久了，就不难发现实现一个<strong>库</strong>（俗称轮子）跟在公司里埋头写<strong>业务代码</strong>是两种完全不一样的概念，大多数人在公司写代码基本上就是用框架提供的 API 实现业务功能，由于代码跟业务关联性很强，你完全可以一本道，想到什么写什么，像写脚本一样一行一行写下去就行了，反正其他事情有框架帮你兜底。</p>
<p>但框架就完全不一样，框架需要适应所有业务功能，所以它是抽象的，它需要开发者有一定程度的抽象能力，这种能力我个人认为长年累月写业务代码是无法锻炼出来的，前端程序员干三年都未必会写一个 Class（ Java 程序员也一样，只是 Java 要求你必须要写类型，这使得你的代码看起来人模人样的，实际上照样是在写脚本而已😑），所以除了亲自动手造一些轮子以外，阅读框架源码给每一位程序员带来的提升(主要是思想上)是不言而喻的，至少可以带给人一种看起来我也能做的自信心。</p>
<p>话有点多了😦</p>
<p> </p>
<h2 id="reactive-的本质">Reactive 的本质</h2>
<p>这个话题从 Vue2 讲到 Vue3 ，都快被讲烂了，但我觉得重点不在于如何实现，更重要是是理解它的本质，因为 Vue2 和 Vue3 的响应式核心思想是没有太多出入的，不同的只是实现方式。</p>
<p>不过我觉得如果随便抓一个前端来让他实现一个最简单的 Reactivity ，其实真不一定每个人都能做出来，所以我还是花了一些时间去总结，与其说 Reactivity 是一种技术，更贴切的说法应该是一种思想。</p>
<p>它的本质就是当一个被用户关注的数据发生变化时，触发一系列相对应的动作，在 Vue 中这个动作通常是更新页面，这些动作在源码中被描述为 <a href="https://github.com/vuejs/core/blob/main/packages/reactivity/src/effect.ts" target="_blank" rel="noopener noreffer">effect</a> ，官方喜欢用中文<code>副作用</code>来称呼，那么如果要自己实现的话，<code>effect</code>应该是长这样的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">&#34;en&#34;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&#34;UTF-8&#34;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Title<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;module&#34;</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;./main.js&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;app&#34;</span><span class="p">&gt;</span>Hello!<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="cm">/*=== main.js ===*/</span>

<span class="c1">//挂载到 window 上方便演示
</span><span class="c1"></span><span class="nb">window</span><span class="p">.</span><span class="nx">text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">effect</span> <span class="o">=</span> <span class="nx">effect</span>

<span class="kd">function</span> <span class="nx">effect</span><span class="p">()</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">root</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;app&#39;</span><span class="p">)</span>
    <span class="nx">root</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">text</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/effect.gif"
        data-srcset="https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/effect.gif, https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/effect.gif 1.5x, https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/effect.gif 2x"
        data-sizes="auto"
        alt="https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/effect.gif"
        title="https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/effect.gif" /></p>
<p>这就是 Reactivity 的雏形，当我把 text 的值改变后，手动触发了一下<code>effect()</code>，页面上的值就更新了，但显然这跟预期有很大出入，这响应式怎么还要手动触发？</p>
<p>于是，一个十分天才的想法诞生了，如果把所有引用了<code>text</code>这个值的<code>effect</code>看作为<code>text</code>的<strong>依赖</strong>收集起来，当我们改变<code>text</code>的值的时候，把这些<strong>依赖</strong>都执行一遍，那不就完美解决了这个问题了吗。</p>
<p> </p>
<h2 id="ref-实现">ref 实现</h2>
<p>Vue3 源码中，<a href="https://github.com/vuejs/core/blob/main/packages/reactivity/src/ref.ts" target="_blank" rel="noopener noreffer">ref.ts</a> 的核心逻辑除去注释只有不到 300 行代码，不看具体实现（如 track 的过程等）的话，非常容易理解它在试图做些什么。</p>
<p>先看一下它的两个关键的单测：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="cm">/** 官方仓库： packages/reactivity/__tests__/ref.spec.ts **/</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;reactivity/ref&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">//给 ref 传一个值，可以通过 .value 获取到
</span><span class="c1"></span>  <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should hold a value&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">value</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">value</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
  <span class="p">})</span>
    <span class="c1">//而且这个值会是响应式的
</span><span class="c1"></span>  <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should be reactive&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="kd">let</span> <span class="nx">dummy</span>
    <span class="kd">let</span> <span class="nx">calls</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nx">effect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">calls</span><span class="o">++</span>
      <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">value</span>
    <span class="p">})</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">calls</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">dummy</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">calls</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">dummy</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1">// 如果是值没有改变，那么就 calls 就不变
</span><span class="c1"></span>    <span class="nx">a</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">calls</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
  <span class="p">})</span>
<span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div><p>了解了大概的用法之后就可以开始动手实现了，先试试攻克第一个测试吧。</p>
<p>传给 ref 的参数 1 是一个基本的数字类型，数字类型是不可能有 .value 属性的，所以 ref 内部肯定是返回了一个对象🤔，我们就称他为<code>RefImpl</code>吧（好吧这个名字是直接从源码里抄的，你可以直接在源码里搜索到）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="cm">/** ref.ts **/</span>
<span class="kr">class</span> <span class="nx">RefImpl</span> <span class="p">{</span>
    <span class="kr">private</span> <span class="nx">_value</span>: <span class="kt">any</span>
    
    <span class="kr">constructor</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_value</span> <span class="o">=</span> <span class="nx">value</span>
    <span class="p">}</span>
    <span class="kr">get</span> <span class="nx">value() {</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_value</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>然后是 ref 方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="cm">/** ref.ts **/</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">ref</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">RefImpl</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>至此，第一个单测应该是可以通过的，ref 方法将 value 参数传递给<code>RefImpl</code>的构造函数，提供一个<code>get</code>方法，将这个<code>RefImpl</code>返回出去就即可。</p>
<p>不难发现，之所以要封装一个<code>RefImpl</code>类，是为了可以实现一些拦截的动作，当用户使用 .value 获取值的时候，可以利用类的<code>get</code>方法拦截这个动作，来达到<strong>收集依赖</strong>的目的，而当用户利用<code>set</code>方法来试图改变这个值的时候，便可以<strong>触发依赖</strong>，将收集到的依赖执行，来达到响应式的目的。</p>
<p>所以接下来就可以开始动手攻克第二个测试了，试试将数据变成响应式的吧。</p>
<p>在 Vue3 的 Reactive 中，<code>effect</code>起到一个非常关键的作用，可以说是 Reactive 的核心，Vue3 提供<code>reactive</code>和<code>ref</code>这两个响应式的 API，无论用户使用哪个，最终<strong>收集依赖</strong>都是通过<code>effect</code>来完成的，<code>reactive</code>和<code>ref</code>主要是做一些拦截的动作，为<code>effect</code>提供入口。</p>
<p><code>effect()</code> 接收一个函数作为参数，并封装到 <code>ReactiveEffect</code> 类中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="cm">/** effect.ts **/</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">effect</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//将依赖封装到 reactiveeffect 类的run方法中
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">_effect</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ReactiveEffect</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span>
    <span class="c1">//马上执行一下
</span><span class="c1"></span>    <span class="nx">_effect</span><span class="p">.</span><span class="nx">run</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="cm">/** effect.ts **/</span>

<span class="c1">//全局容器，用于保存当前的 ReactiveEffect 实例
</span><span class="c1"></span><span class="kd">let</span> <span class="nx">activeEffect</span>: <span class="kt">any</span>

<span class="kr">class</span> <span class="nx">ReactiveEffect</span> <span class="p">{</span>
     <span class="kr">private</span> <span class="kr">readonly</span> <span class="nx">_fn</span>: <span class="kt">any</span>

    <span class="kr">constructor</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_fn</span> <span class="o">=</span> <span class="nx">fn</span>
    <span class="p">}</span>
    <span class="c1">//封装的 run 方法，执行 effect 传入的回调函数
</span><span class="c1"></span>    <span class="nx">run() {</span>
        <span class="nx">activeEffect</span> <span class="o">=</span> <span class="k">this</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_fn</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>将 fn 封装到 <code>ReactiveEffect</code> 之后，会立即调用一次 run 方法，这是为了触发一下依赖收集。</p>
<p>「执行一下是为了触发一下依赖收集」这句话可能会让人有点摸不着头脑，其实可以用单测的用例作为例子说明：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should be reactive&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">//声明了一个响应式的值
</span><span class="c1"></span>    <span class="kr">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="kd">let</span> <span class="nx">dummy</span>
    <span class="nx">effect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// effect 每次执行的时候，让 dymmy = a.value  
</span><span class="c1"></span>      <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">value</span>
    <span class="p">})</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">dummy</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div><p>可以看到，传给 effect 的回调函数中，引用了响应式数据<code>a </code>，当这个回调被执行，a.value 会被触发，这时候必然会进入到之前在 <code>RefImpl</code> 事先定义好的 get 拦截器中，所以这就是收集依赖的好时机。</p>
<p>所以，现在来实现一下，在响应式对象的 get 被调用时，执行<code>track</code>函数来进行依赖收集：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="hl"><span class="lnt"> 6
</span></span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="hl"><span class="lnt"> 9
</span></span><span class="lnt">10
</span><span class="lnt">11
</span><span class="hl"><span class="lnt">12
</span></span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="cm">/** ref.ts **/</span>
<span class="kr">import</span> <span class="p">{</span><span class="nx">track</span><span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;./effect&#34;</span><span class="p">;</span>

<span class="kr">class</span> <span class="nx">RefImpl</span> <span class="p">{</span>
    <span class="kr">private</span> <span class="nx">_value</span>: <span class="kt">any</span>
<span class="hl">    <span class="kr">public</span> <span class="nx">deps</span>
</span>    <span class="kr">constructor</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_value</span> <span class="o">=</span> <span class="nx">value</span>
<span class="hl">        <span class="k">this</span><span class="p">.</span><span class="nx">deps</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Set</span><span class="p">()</span>
</span>    <span class="p">}</span>
    <span class="kr">get</span> <span class="nx">value() {</span>
<span class="hl">        <span class="nx">track</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">deps</span><span class="p">)</span>
</span>        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_value</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>在构造函数中初始化一个用于保存依赖的集合<code>deps </code>，之所以是 Set 主要是为了避免重复收集。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="cm">/** effect.ts **/</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">track</span><span class="p">(</span><span class="nx">dep</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//不再重复收集
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">dep</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">activeEffect</span><span class="p">))</span> <span class="k">return</span>
    <span class="nx">dep</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">activeEffect</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>为 <code>track</code>传入响应式对象的 <code>dep</code> 集合，<code>track</code>函数将当前全局保存的 <code>activeEffect</code> 对象存到<code>dep</code>集合中。</p>
<p>实际上到这一步，依赖收集就已经完成了。所以接下来，只要<strong>当响应式对象的值被改变的时候，触发收集到的所有依赖</strong>，就这个简单的响应式流程就完成了。</p>
<p>所以，在响应式对象的 set 方法中拦截请求，在修改值后，调用 <code>trigger</code> 方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="hl"><span class="lnt"> 2
</span></span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="hl"><span class="lnt">11
</span></span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="hl"><span class="lnt">16
</span></span><span class="hl"><span class="lnt">17
</span></span><span class="hl"><span class="lnt">18
</span></span><span class="hl"><span class="lnt">19
</span></span><span class="hl"><span class="lnt">20
</span></span><span class="hl"><span class="lnt">21
</span></span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="cm">/** ref.ts **/</span>
<span class="hl"><span class="kr">import</span> <span class="p">{</span><span class="nx">track</span><span class="p">,</span><span class="nx">trigger</span><span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;./effect&#34;</span><span class="p">;</span>
</span>
<span class="kr">class</span> <span class="nx">RefImpl</span> <span class="p">{</span>
    <span class="kr">private</span> <span class="nx">_value</span>: <span class="kt">any</span>
    <span class="kr">public</span> <span class="nx">deps</span>
    <span class="kr">constructor</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_value</span> <span class="o">=</span> <span class="nx">value</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">deps</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Set</span><span class="p">()</span>
    <span class="p">}</span>
<span class="hl">    <span class="c1">//收集依赖
</span></span><span class="c1"></span>    <span class="kr">get</span> <span class="nx">value() {</span>
        <span class="nx">track</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">deps</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_value</span>
    <span class="p">}</span>
<span class="hl">    
</span><span class="hl">    <span class="c1">//触发依赖
</span></span><span class="hl"><span class="c1"></span>    <span class="kr">set</span> <span class="nx">value</span><span class="p">(</span><span class="nx">newVal</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hl">       <span class="k">this</span><span class="p">.</span><span class="nx">_value</span> <span class="o">=</span> <span class="nx">newVal</span>
</span><span class="hl">       <span class="nx">trigger</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">deps</span><span class="p">)</span>
</span><span class="hl">    <span class="p">}</span>
</span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="cm">/** effect.ts **/</span>
<span class="kr">export</span> <span class="kd">function</span> <span class="nx">trigger</span><span class="p">(</span><span class="nx">dep</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">effect</span> <span class="k">of</span> <span class="nx">dep</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">effect</span><span class="p">.</span><span class="nx">run</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>在 set 拦截器中，首先需要将响应式对象的 value 赋值为新的值，然后调用<code>trigger</code>方法，将收集到的<code>deps</code>全部传进去，而 <code>trigger</code> 只需要将这些 effect 全部执行一遍就可以了。</p>
<p>不妨在本地跑一下单测试试看：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/test.gif"
        data-srcset="https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/test.gif, https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/test.gif 1.5x, https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/test.gif 2x"
        data-sizes="auto"
        alt="https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/test.gif"
        title="https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/test.gif" /></p>
<p>没有问题。</p>
<p> </p>
<h2 id="打包并测试-ref">打包并测试 ref</h2>
<p>本次测试的目标，是看看对响应式数据的更改能不能如期反映到页面上。</p>
<p>首先需要将实现的库打包，对于库代码的打包，像 Vue3 一样使用 <code>rollup</code>就可以了。</p>
<p>先将本次需要用到的 <code>ref</code> 和 <code>effect</code> 统一导出：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="cm">/** src/reactivity/index.ts **/</span>
<span class="kr">export</span> <span class="p">{</span><span class="nx">effect</span><span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;./effect&#34;</span>
<span class="kr">export</span> <span class="p">{</span><span class="nx">ref</span><span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;./ref&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>然后在 <code>rollup</code> 的入口文件里面导出：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="cm">/** src/index.ts **/</span>
<span class="kr">export</span> <span class="o">*</span> <span class="kr">from</span> <span class="s2">&#34;./reactivity/index&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>安装依赖：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">yarn add rollup --dev
</code></pre></td></tr></table>
</div>
</div><p>由于用到了 typescript，还需要安装一下 <code>rollup</code> 提供的 ts 插件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">yarn add @rollup/plugin-typescript --dev
yarn add tslib --dev
</code></pre></td></tr></table>
</div>
</div><p>添加<code>rollup.config.js</code>配置文件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kr">import</span> <span class="nx">typescript</span> <span class="nx">from</span> <span class="s2">&#34;@rollup/plugin-typescript&#34;</span>

<span class="kr">export</span> <span class="k">default</span> <span class="p">{</span>
    <span class="nx">input</span><span class="o">:</span> <span class="s2">&#34;./src/index.ts&#34;</span><span class="p">,</span> <span class="c1">//入口
</span><span class="c1"></span>    <span class="nx">output</span><span class="o">:</span> <span class="p">[{</span> <span class="c1">//出口
</span><span class="c1"></span>        <span class="nx">format</span><span class="o">:</span> <span class="s2">&#34;es&#34;</span><span class="p">,</span>
        <span class="nx">file</span><span class="o">:</span> <span class="s2">&#34;lib/esm.js&#34;</span>
    <span class="p">}],</span>
    <span class="nx">plugins</span><span class="o">:</span> <span class="p">[</span><span class="nx">typescript</span><span class="p">()]</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>打包：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">yarn build
</code></pre></td></tr></table>
</div>
</div><p>最后，还原一开始的那个用例，不过注意看，这个时候<code>id=&quot;app&quot;</code>的 div 内容是空的 ：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">&#34;en&#34;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&#34;UTF-8&#34;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Demo<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;module&#34;</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;./main.js&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;app&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>在这里，利用 ref 去初始化元素的内容为”Hello Ref !“</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="cm">/** main.js **/</span>
<span class="kr">import</span> <span class="o">*</span> <span class="nx">as</span> <span class="nx">Ref</span> <span class="nx">from</span> <span class="s2">&#34;../../lib/esm.js&#34;</span>
<span class="kr">import</span> <span class="o">*</span> <span class="nx">as</span> <span class="nx">Effect</span> <span class="nx">from</span> <span class="s2">&#34;../../lib/esm.js&#34;</span>

<span class="kr">const</span> <span class="p">{</span><span class="nx">ref</span><span class="p">}</span> <span class="o">=</span> <span class="nx">Ref</span>
<span class="kr">const</span> <span class="p">{</span><span class="nx">effect</span><span class="p">}</span> <span class="o">=</span> <span class="nx">Effect</span>

<span class="kr">const</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="s2">&#34;Hello Ref !&#34;</span><span class="p">)</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span>

<span class="nx">effect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">root</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;app&#39;</span><span class="p">)</span>
    <span class="nx">root</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">value</span>
<span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div><p>根据 effect 的特性，需要马上执行一次回调函数，进行依赖收集，所以这个时候页面上应该显示<code>&quot;Hello Ref !&quot;</code>，来看看效果：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/final.gif"
        data-srcset="https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/final.gif, https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/final.gif 1.5x, https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/final.gif 2x"
        data-sizes="auto"
        alt="https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/final.gif"
        title="https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/final.gif" /></p>
<p>效果跟预期的一致。所以，大功告成！🎉</p>
<p> </p>
<h2 id="优化">优化</h2>
<p>记不记得在单测中还有一个小功能，就是 ref 的值被改变时，如果新的值跟原有的值一样，那么是不会触发<code>trigger</code>的，优化了一些性能，所以在最后，来把这个功能点也实现一下吧。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="hl"><span class="lnt">14
</span></span><span class="hl"><span class="lnt">15
</span></span><span class="hl"><span class="lnt">16
</span></span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript">  <span class="nx">it</span><span class="p">(</span><span class="s1">&#39;should be reactive&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="kd">let</span> <span class="nx">dummy</span>
    <span class="kd">let</span> <span class="nx">calls</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nx">effect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">calls</span><span class="o">++</span>
      <span class="nx">dummy</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">value</span>
    <span class="p">})</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">calls</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">dummy</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">calls</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">dummy</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="hl">    <span class="c1">// 如果是值没有改变，那么就 calls 就不变
</span></span><span class="hl"><span class="c1"></span>    <span class="nx">a</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="mi">2</span>
</span><span class="hl">    <span class="nx">expect</span><span class="p">(</span><span class="nx">calls</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span>  <span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div><p>思路很简单，每次设置新的值的时候，对比一下新旧的值是否相等，如果不相等就执行<code>trigger</code>，相等的话就返回</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="hl"><span class="lnt"> 4
</span></span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="hl"><span class="lnt"> 8
</span></span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="hl"><span class="lnt">22
</span></span><span class="hl"><span class="lnt">23
</span></span><span class="lnt">24
</span><span class="lnt">25
</span><span class="hl"><span class="lnt">26
</span></span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="hl"><span class="lnt">30
</span></span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="cm">/** ref.ts **/</span>
<span class="kr">class</span> <span class="nx">RefImpl</span> <span class="p">{</span>
    <span class="kr">private</span> <span class="nx">_value</span>: <span class="kt">any</span>
<span class="hl">    <span class="kr">private</span> <span class="nx">_rawValue</span>: <span class="kt">any</span>
</span>    <span class="kr">public</span> <span class="nx">deps</span>

    <span class="kr">constructor</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
<span class="hl">        <span class="k">this</span><span class="p">.</span><span class="nx">_rawValue</span> <span class="o">=</span> <span class="nx">value</span>
</span>        <span class="k">this</span><span class="p">.</span><span class="nx">_value</span> <span class="o">=</span> <span class="nx">value</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">deps</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Set</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="c1">//收集依赖
</span><span class="c1"></span>    <span class="kr">get</span> <span class="nx">value() {</span>
        <span class="nx">track</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">deps</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_value</span>
    <span class="p">}</span>

    <span class="c1">//触发依赖
</span><span class="c1"></span>    <span class="kr">set</span> <span class="nx">value</span><span class="p">(</span><span class="nx">newVal</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//如果数据没有变更，不触发依赖
</span><span class="hl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nx">hasChanged</span><span class="p">(</span><span class="nx">newVal</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_rawValue</span><span class="p">))</span> <span class="p">{</span>
</span><span class="hl">            <span class="k">this</span><span class="p">.</span><span class="nx">_rawValue</span> <span class="o">=</span> <span class="nx">newVal</span>
</span>            <span class="k">this</span><span class="p">.</span><span class="nx">_value</span> <span class="o">=</span> <span class="nx">newVal</span>
            <span class="nx">trigger</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">deps</span><span class="p">)</span>
<span class="hl">        <span class="p">}</span>
</span>    <span class="p">}</span>
<span class="p">}</span>

<span class="hl"><span class="kr">const</span> <span class="nx">hasChanged</span> <span class="o">=</span> <span class="p">(</span><span class="nx">newVal</span><span class="p">,</span> <span class="nx">oldVal</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="o">!</span><span class="nb">Object</span><span class="p">.</span><span class="k">is</span><span class="p">(</span><span class="nx">newVal</span><span class="p">,</span> <span class="nx">oldVal</span><span class="p">)</span>
</span></code></pre></td></tr></table>
</div>
</div><p>再来执行一下单测看看是否可以通过：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/finaltest.gif"
        data-srcset="https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/finaltest.gif, https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/finaltest.gif 1.5x, https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/finaltest.gif 2x"
        data-sizes="auto"
        alt="https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/finaltest.gif"
        title="https://wumanhoblogimg.obs.cn-south-1.myhuaweicloud.com/images/reactivity/finaltest.gif" /></p>
<p>顺利通过。</p>
<p> </p>
<h2 id="总结">总结</h2>
<p>这次实现的<code>ref </code>只是 Reactivity 中的其中一个小部分，<code>ref</code>只能对值数据进行拦截，如果需要对一个对象进行拦截，就要实现<code>reactive</code>方法，但核心思路没有太大的区别，经常听说的 Vue3 使用了 ES6 的<code>Proxy</code>实现了响应式就是从这里来的，不过碍于篇幅，<code>reactive</code>可能会在下一篇博客中再尝试实现，敬请期待。</p>
<p><a href="https://github.com/wumanho/vue-ref-for-blog" target="_blank" rel="noopener noreffer">查看本次演示的代码仓库</a></p>
<p> </p>
<p>（完）</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2022-03-16</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/vue3/">Vue3</a>,&nbsp;<a href="/tags/%E6%BA%90%E7%A0%81/">源码</a>,&nbsp;<a href="/tags/%E5%93%8D%E5%BA%94%E5%BC%8F/">响应式</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/cfworkers/" class="prev" rel="prev" title="【Cloudflare Workers】无服务器应用初体验"><i class="fas fa-angle-left fa-fw"></i>【Cloudflare Workers】无服务器应用初体验</a>
            <a href="/posts/webhook-auto-deploy/" class="next" rel="next" title="利用 Github Webhooks 实现博客自动部署">利用 Github Webhooks 实现博客自动部署<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.92.2">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2019 - 2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/about/" target="_blank">wumanho</a></span><span class="icp-splitter">&nbsp;|&nbsp;</span><br class="icp-br"/>
                    <span class="icp">粤ICP备20015586号</span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":90},"comment":{},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
